{% extends 'registration/base_login.html' %}
{% load static %}

{# Título de la página para el paso de nueva contraseña #}
{% block title %}Nueva contraseña{% endblock %}

{% block content %}
<style>
/* Contenedor general centrado para la tarjeta */
.vsms-wrapper {
  min-height: 100vh;
  width: 100vw;
  overflow-x: hidden;
  overflow-y: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 40px 12px 30px 12px;
}

/* Fondos (claro / oscuro) */
.vsms-bg-img,
.vsms-bg-img-dark {
  position: fixed;
  left: 0; top: 0;
  min-width: 100vw; min-height: 100vh;
  width: 100vw; height: 100vh;
  z-index: 0;
  pointer-events: none;
  user-select: none;
  object-fit: cover;
}
.vsms-bg-img-dark { display: none; }
body.modo-oscuro .vsms-bg-img { display: none !important; }
body.modo-oscuro .vsms-bg-img-dark { display: block !important; }

/* Tarjeta central de nueva contraseña */
.vsms-card {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 640px;
  border-radius: 40px;
  overflow: hidden;
  background: #f1dfc7;
  z-index: 1;
  margin: 0 auto;
  border: 3px solid #00B543;
  box-shadow: 0 18px 55px rgba(0, 0, 0, 0.45);
  transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s;
}
body.modo-oscuro .vsms-card {
  background: #142620;
  border-color: #00FF5A;
  box-shadow: 0 0 70px #000000aa;
}

/* Contenido interno de la tarjeta */
.vsms-left {
  flex: 1;
  padding: 32px 30px 28px 30px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/* Botón “volver” circular */
.vsms-back {
  position: absolute;
  left: 24px;
  top: 22px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 2px solid #00B543;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: transparent;
  transition: background .15s, transform .08s, box-shadow .12s;
  text-decoration: none;
}
.vsms-back-icon {
  width: 18px;
  height: 18px;
  border-left: 3px solid #00B543;
  border-bottom: 3px solid #00B543;
  transform: rotate(45deg);
}
.vsms-back:hover {
  background: rgba(0,0,0,0.03);
  box-shadow: 0 3px 9px rgba(0,0,0,0.25);
  transform: translateY(-1px);
}
body.modo-oscuro .vsms-back { border-color: #71FF9E; }
body.modo-oscuro .vsms-back-icon {
  border-left-color: #71FF9E;
  border-bottom-color: #71FF9E;
}

/* Título + logo */
.vsms-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
  margin-left: 70px;
}
.vsms-title-logo img { width: 44px; height: 44px; }
.vsms-title-text {
  font-family: 'Nunito', sans-serif;
  font-size: 1.9rem;
  font-weight: 900;
  color: #149c3e;
}
body.modo-oscuro .vsms-title-text { color: #29FF66; }

/* Texto descriptivo de ayuda */
.vsms-desc {
  margin-left: 70px;
  margin-right: 10px;
  margin-bottom: 14px;
  font-size: 0.92rem;
  color: #184321;
  line-height: 1.4;
}
body.modo-oscuro .vsms-desc { color: #E9FFE9; }

/* Contenedor del formulario */
.vsms-form {
  margin-left: 40px;
  margin-right: 40px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Envoltorio de cada input (para el botón ojo) */
.vsms-input-wrap {
  position: relative;
}

/* Inputs de contraseña */
.vsms-input {
  border-radius: 999px;
  border: 2px solid #6BE899;
  font-size: 0.96rem;
  background: #FFFFFF;
  color: #333333;
  width: 100%;
  padding: 12px 44px 12px 20px;
  outline: none;
  text-align: left;
  letter-spacing: 0;
  font-weight: 500;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.12s ease;
}
.vsms-input:hover {
  box-shadow: 0 3px 9px rgba(0,0,0,0.18);
  transform: translateY(-1px);
}
.vsms-input:focus {
  border-color: #00B543;
  box-shadow: 0 0 0 2px #00b54344;
  transform: translateY(-1px);
}
.vsms-input.is-invalid { border-color: #ff4b4b !important; }

/* Botón “ojo” para mostrar/ocultar contraseña */
.vsms-eye-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
}
.vsms-eye-btn img {
  width: 18px;
  height: 18px;
  display: block;
  object-fit: contain;
}

/* Mensajes de error de validación */
.vsms-error {
  font-size: 0.8rem;
  margin-top: 4px;
  color: #cc1f1f;
  text-align: left;
}

/* Botón principal para enviar nueva contraseña */
.vsms-btn {
  width: 100%;
  background: linear-gradient(90deg,#24c34f,#18a83f);
  color: #FFFFFF;
  font-weight: 700;
  padding: 13px 0;
  font-size: 1rem;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
}
.vsms-btn:hover,
.vsms-btn:focus {
  background: linear-gradient(90deg,#1EA344,#148338);
  box-shadow: 0 0 0 2px #00b54344;
  transform: translateY(-1px);
}

/* Texto de ayuda inferior */
.vsms-help {
  margin-top: 10px;
  font-size: 0.86rem;
  text-align: center;
  color: #3c5a46;
}
body.modo-oscuro .vsms-help { color: #CFF5D8; }

/* Botón flotante de tema */
.theme-toggle-btn {
  position: fixed;
  top: 23px;
  right: 32px;
  z-index: 1200;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #F9F9FB;
  color: #30AE37;
  box-shadow: 0 2px 8px #238c3520;
  border: 2px solid #D8EDD6;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 2rem;
  transition: background 0.18s, color 0.16s, border 0.15s,
              transform 0.08s, box-shadow 0.12s;
}
.theme-toggle-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px #238c3538;
}
body.modo-oscuro .theme-toggle-btn {
  background: #232D21;
  color: #97F088;
  border: 2px solid #297B36;
}
.theme-toggle-btn img {
  width: 32px;
  height: 32px;
  display: block;
  pointer-events: none;
}
.theme-toggle-btn:focus { outline: 3px solid #97F08888; }

/* Ajustes para tablet */
@media (max-width: 900px) {
  .vsms-left {
    padding: 28px 22px 24px 22px;
  }
  .vsms-title { margin-left: 50px; }
  .vsms-desc { margin-left: 50px; margin-right: 16px; }
}

/* Ajustes para móviles pequeños */
@media (max-width: 480px) {
  .vsms-card {
    border-radius: 30px;
  }
  .vsms-left {
    padding: 26px 18px 22px 18px;
  }

  /* Flecha más abajo para no chocar con logo */
  .vsms-back {
    left: 16px;
    top: 34px;
    width: 42px;
    height: 42px;
  }

  /* Logo + título centrados horizontalmente */
  .vsms-title {
    margin-left: 0;
    margin-top: 10px;
    justify-content: center;
  }
  .vsms-title-logo img {
    width: 42px;
    height: 42px;
  }
  .vsms-title-text {
    font-size: 1.6rem;
    text-align: center;
  }

  /* Descripción algo más estrecha y centrada visualmente */
  .vsms-desc {
    margin-left: 0;
    margin-right: 0;
    font-size: 0.9rem;
    text-align: left;
  }

  /* Formulario más ancho en móvil */
  .vsms-form {
    margin-left: 10px;
    margin-right: 10px;
  }

  /* Placeholder más legible en móvil (ligera reducción) */
  .vsms-input {
    font-size: 0.9rem;          /* baja un poco para que quepa el placeholder */
    padding: 11px 44px 11px 18px;
  }

  /* Ojo un pelín más grande y centrado */
  .vsms-eye-btn {
    width: 30px;
    height: 30px;
    right: 8px;
  }
  .vsms-eye-btn img {
    width: 20px;
    height: 20px;
  }

  /* Botón principal con texto más pequeño para no “reventar” el borde */
  .vsms-btn {
    padding: 11px 0;
    font-size: 0.9rem;
  }

  /* Botón modo claro/oscuro reubicado para no cruzarse con nada */
  .theme-toggle-btn {
    top: 10px;
    right: 16px;
  }

  .vsms-help {
    font-size: 0.8rem;
  }
}

</style>

{# Fondos de la página #}
<img src="{% static 'img/fondo-ondas.png' %}" alt="Fondo ondas claro" class="vsms-bg-img">
<img src="{% static 'img/fondo-oscuro.png' %}" alt="Fondo ondas oscuro" class="vsms-bg-img-dark">

{# Botón para alternar tema claro/oscuro #}
<button type="button" class="theme-toggle-btn" id="themeToggleBtn" aria-label="Alternar tema">
  <img id="iconSunMoon" src="{% static 'img/theme-toggle.png' %}" alt="Tema claro/oscuro">
</button>
<script>
/*
  Alterna modo oscuro/claro y persiste la preferencia en localStorage.
*/
(function(){
  const btn = document.getElementById("themeToggleBtn");
  const img = document.getElementById("iconSunMoon");
  let modo = localStorage.getItem('modo-oscuro') === 'true';
  if (modo) {
    document.body.classList.add('modo-oscuro');
    img.style.filter = "invert(0.7)";
  }
  btn.onclick = function() {
    modo = !modo;
    document.body.classList.toggle('modo-oscuro');
    localStorage.setItem('modo-oscuro', modo ? 'true' : '');
    img.style.filter = modo ? "invert(0.7)" : "";
  };
})();
</script>

{# Tarjeta de nueva contraseña #}
<div class="vsms-wrapper">
  <div class="vsms-card">
    <div class="vsms-left">

      {# Botón para volver al login (por si el usuario abandona el flujo) #}
      <a href="{% url 'login' %}" class="vsms-back" aria-label="Volver al inicio de sesión">
        <span class="vsms-back-icon"></span>
      </a>

      {# Logo y título de la pantalla #}
      <div class="vsms-title">
        <div class="vsms-title-logo">
          <img src="{% static 'img/logo.png' %}" alt="Logo cooperativa">
        </div>
        <div class="vsms-title-text">Nueva contraseña</div>
      </div>

            {# Texto explicativo sobre la creación de la nueva contraseña #}
      <div class="vsms-desc">
        Crea una nueva contraseña para tu cuenta.
        La contraseña se considera más segura con al menos 6 caracteres, mayúsculas, números y símbolos.
      </div>

      {# Formulario sin Django Form: campos HTML nativos para las contraseñas #}
      <form method="post" class="vsms-form" novalidate autocomplete="off">
        {% csrf_token %}

        {# Campo de nueva contraseña con botón de ojo #}
        <div class="vsms-input-wrap">
          <input type="password"
                 name="password1"
                 id="id_password1"
                 class="vsms-input"
                 placeholder="Nueva contraseña"
                 minlength="6"
                 maxlength="20"
                 autocomplete="new-password">
          <button type="button"
                  class="vsms-eye-btn"
                  data-target="id_password1"
                  aria-label="Mostrar u ocultar contraseña">
            <img src="{% static 'img/mostrar_contrasena.png' %}" alt="Mostrar contraseña">
          </button>
        </div>

        {# Campo de confirmación de contraseña con botón de ojo #}
        <div class="vsms-input-wrap">
          <input type="password"
                 name="password2"
                 id="id_password2"
                 class="vsms-input"
                 placeholder="Confirma la nueva contraseña"
                 minlength="6"
                 maxlength="20"
                 autocomplete="new-password">
          <button type="button"
                  class="vsms-eye-btn"
                  data-target="id_password2"
                  aria-label="Mostrar u ocultar contraseña">
            <img src="{% static 'img/mostrar_contrasena.png' %}" alt="Mostrar contraseña">
          </button>
        </div>

        {# ÚNICO mensaje de error para ambos campos #}
        <div id="error_password" class="vsms-error" style="display:none;"></div>

        {# Botón para enviar la nueva contraseña al servidor #}
        <button type="submit" class="vsms-btn">
          Guardar nueva contraseña
        </button>
      </form>

      {# Texto informativo al pie #}
      <div class="vsms-help">
        Después de guardar, podrás iniciar sesión normalmente con tu nueva contraseña.
      </div>

<script>
/*
  Lógica para los "ojos" de mostrar/ocultar contraseña:
  - Cambia el tipo del input entre password / text.
  - Alterna también el icono y el alt.
*/
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.vsms-eye-btn');
  if (!btn) return;

  const targetId = btn.getAttribute('data-target');
  const input = document.getElementById(targetId);
  if (!input) return;

  const img = btn.querySelector('img');
  const visible = input.type === 'text';

  if (visible) {
    input.type = 'password';
    img.src = "{% static 'img/mostrar_contrasena.png' %}";
    img.alt = "Mostrar contraseña";
  } else {
    input.type = 'text';
    img.src = "{% static 'img/ocultar_contrasena.png' %}";
    img.alt = "Ocultar contraseña";
  }
});

/*
  Validación front-end antes de enviar:
  - password1 mínimo 6 caracteres.
  - password2 mínimo 6 caracteres.
  - Ambas deben coincidir.
  - Un solo mensaje de error (debajo del segundo campo).
*/
document.addEventListener('submit', function(e){
  const form = e.target;
  if (!form.classList.contains('vsms-form')) return;

  const p1  = document.getElementById('id_password1');
  const p2  = document.getElementById('id_password2');
  const err = document.getElementById('error_password');

  // limpiar estilos y mensaje previo
  [p1, p2].forEach(el => el.classList.remove('is-invalid'));
  err.style.display = 'none';
  err.textContent   = '';

  let hasError = false;

  // validar password1 (nueva contraseña)
  if (!p1.value || p1.value.length < 6) {
    p1.classList.add('is-invalid');
    err.textContent = "La contraseña debe tener al menos 6 caracteres.";
    err.style.display = 'block';
    hasError = true;
  }

  // validar password2 (confirmación) vacío o corto
  if (!p2.value || p2.value.length < 6) {
    p2.classList.add('is-invalid');
    err.textContent = "Debes confirmar la contraseña (mínimo 6 caracteres).";
    err.style.display = 'block';
    hasError = true;
  }

  // si ambas tienen longitud suficiente, validar que coincidan
  if (!hasError && p1.value !== p2.value) {
    p1.classList.add('is-invalid');
    p2.classList.add('is-invalid');  // ambos en rojo cuando no coinciden
    err.textContent = "Las contraseñas no coinciden.";
    err.style.display = 'block';
    hasError = true;
  }

  if (hasError) {
    e.preventDefault();
  }
});
</script>

{% endblock %}
